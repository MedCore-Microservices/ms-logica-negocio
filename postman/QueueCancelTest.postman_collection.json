{
  "info": {
    "name": "Queue Cancel Tests",
    "_postman_id": "a1b2c3d4-queue-cancel",
    "description": "Colección para probar la cancelación de tickets en /api/queue (B2). Importar en Postman y usar las variables de entorno indicadas.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Create ticket - Patient 1 (join)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"doctorId\": {{doctorId}},\n  \"patientId\": {{patient1}}\n}"
        },
        "url": "{{baseUrl}}/api/queue/join"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "// Guardar ticketId en la variable ticket1 si la creación fue exitosa",
              "if (pm.response.code === 201) {",
              "  const json = pm.response.json();",
              "  if (json && json.data && json.data.ticket && json.data.ticket.id) {",
              "    pm.environment.set('ticket1', json.data.ticket.id);",
              "  }",
              "}",
              "pm.test('status is 201', function () { pm.response.to.have.status(201); });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Create ticket - Patient 2 (join)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"doctorId\": {{doctorId}},\n  \"patientId\": {{patient2}}\n}"
        },
        "url": "{{baseUrl}}/api/queue/join"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "  const json = pm.response.json();",
              "  if (json && json.data && json.data.ticket && json.data.ticket.id) {",
              "    pm.environment.set('ticket2', json.data.ticket.id);",
              "  }",
              "}",
              "pm.test('status is 201', function () { pm.response.to.have.status(201); });"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Get waiting for doctor",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "url": "{{baseUrl}}/api/queue/doctor/{{doctorId}}/waiting"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status is 200', function () { pm.response.to.have.status(200); });",
              "// Guardar lista de waiting en variable para inspección manual",
              "const json = pm.response.json();",
              "if (json && json.data) pm.environment.set('lastWaiting', JSON.stringify(json.data));"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Cancel ticket 1",
      "request": {
        "method": "DELETE",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "url": "{{baseUrl}}/api/queue/ticket/{{ticket1}}/cancel"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status is 200', function () { pm.response.to.have.status(200); });",
              "const json = pm.response.json();",
              "pm.test('response includes cancelled ticket', function () { pm.expect(json.data).to.have.property('cancelled'); });",
              "// Guardar waiting result devuelto por el endpoint para inspección",
              "if (json && json.data && json.data.waiting) pm.environment.set('afterCancelWaiting', JSON.stringify(json.data.waiting));"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Get position of ticket 2",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Bearer {{token}}" }
        ],
        "url": "{{baseUrl}}/api/queue/ticket/{{ticket2}}/position"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test('status is 200', function () { pm.response.to.have.status(200); });",
              "// Imprimir la posición en la consola de Postman para verificar",
              "console.log('Position response:', pm.response.json());"
            ],
            "type": "text/javascript"
          }
        }
      ]
    }
  ],
  "event": [],
  "variable": [
    { "key": "baseUrl", "value": "http://localhost:3002" },
    { "key": "token", "value": "<YOUR_TOKEN_HERE>" },
    { "key": "doctorId", "value": "7" },
    { "key": "patient1", "value": "42" },
    { "key": "patient2", "value": "50" },
    { "key": "ticket1", "value": "" },
    { "key": "ticket2", "value": "" }
  ]
}
